#!/bin/bash

#Are we running on slave?
OUTPUT=$(mysql -u root -pmaster -e "select count(1) from information_schema.global_status WHERE variable_name = 'Slave_running' AND variable_value = 'ON';" | head -2 | tail -1``)

if [ -n "$OUTPUT" ]; then #get a syntax error when $OUTPUT is empty
  if [ $OUTPUT == "1" ]; then  #Back it up!
    # Stash the sensu check
    /usr/bin/curl --data "{\"path\":\"silence/$(hostname)/check-mysql-replication-status\",\"content\":{\"message\":\"Silencing during backup\"},\"expire\": 10800}" http://sensu-001.optoro.io:4567/stashes

    /opt/chef/embedded/bin/backup perform --trigger rotation --root-path <%= node['optoro_mysql']['backup_directory'] %>

    # Change sensu check expiration to epire in an hour so it can catch up before alerting
    /usr/bin/curl --data "{\"path\":\"silence/$(hostname)/check-mysql-replication-status\",\"content\":{\"message\":\"Silencing during backup\"},\"expire\": 3600}" http://sensu-001.optoro.io:4567/stashes
  fi
fi
